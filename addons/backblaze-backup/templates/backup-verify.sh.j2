#!/bin/bash
# Backup Verification Script
# Verifies backup integrity and reports status

set -euo pipefail

# Configuration
SCRIPT_NAME="$(basename "$0")"
LOG_FILE="{{ backup_log_path }}/backup-verify.log"
CONFIG_FILE="{{ backup_config_path }}/config.yml"
RCLONE_REMOTE="{{ rclone_config_name }}:{{ rclone_remote_name }}"

# Logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [$SCRIPT_NAME] $1" | tee -a "$LOG_FILE"
}

error() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [$SCRIPT_NAME] ERROR: $1" | tee -a "$LOG_FILE" >&2
    exit 1
}

# Load configuration
load_config() {
    if [[ -f "$CONFIG_FILE" ]]; then
        # Parse YAML (basic parsing)
        BACKUP_PATHS=($(grep -A 20 '^paths:' "$CONFIG_FILE" | grep '^- ' | sed 's/^- "//' | sed 's/"$//' || true))
    else
        error "Configuration file not found: $CONFIG_FILE"
    fi
}

# Verify backup
verify_backup() {
    local total_errors=0
    
    log "Starting backup verification"
    
    for path in "${BACKUP_PATHS[@]}"; do
        if [[ -d "$path" ]]; then
            local remote_path="$RCLONE_REMOTE/$(basename "$path")"
            
            log "Verifying backup for: $(basename "$path")"
            
            # Check if remote directory exists
            if ! rclone lsd "$remote_path" &>/dev/null; then
                log "ERROR: Remote directory not found: $(basename "$path")"
                ((total_errors++))
                continue
            fi
            
            # Compare sizes
            local local_size
            local_size=$(du -sb "$path" | cut -f1)
            local remote_size
            remote_size=$(rclone size "$remote_path" --json 2>/dev/null | jq -r '.bytes // 0' || echo "0")
            
            if [[ "$remote_size" -eq 0 ]]; then
                log "ERROR: Remote backup is empty: $(basename "$path")"
                ((total_errors++))
            elif [[ "$remote_size" -lt "$((local_size * 80 / 100))" ]]; then
                log "WARNING: Remote backup significantly smaller than local: $(basename "$path")"
                log "  Local: $local_size bytes, Remote: $remote_size bytes"
            else
                log "OK: Backup verified for $(basename "$path") ($remote_size bytes)"
            fi
            
            # Check recent files
            local recent_files
            recent_files=$(find "$path" -type f -mtime -7 | wc -l)
            if [[ "$recent_files" -gt 0 ]]; then
                log "  Found $recent_files recent files (last 7 days)"
            fi
            
        else
            log "WARNING: Local path not found: $path"
            ((total_errors++))
        fi
    done
    
    return $total_errors
}

# Check backup age
check_backup_age() {
    log "Checking backup age"
    
    for path in "${BACKUP_PATHS[@]}"; do
        if [[ -d "$path" ]]; then
            local remote_path="$RCLONE_REMOTE/$(basename "$path")"
            
            # Get latest modification time from remote
            local latest_time
            latest_time=$(rclone lsd "$remote_path" --max-depth 1 2>/dev/null | tail -1 | awk '{print $1" "$2}' || echo "")
            
            if [[ -n "$latest_time" ]]; then
                log "Latest backup for $(basename "$path"): $latest_time"
            else
                log "WARNING: Could not determine backup age for $(basename "$path")"
            fi
        fi
    done
}

# Generate report
generate_report() {
    local exit_code=$1
    
    echo ""
    log "Backup verification completed"
    
    if [[ $exit_code -eq 0 ]]; then
        log "STATUS: All backups verified successfully"
    else
        log "STATUS: $exit_code issues found during verification"
    fi
    
    # Send to system log
    if [[ $exit_code -eq 0 ]]; then
        logger -t "$SCRIPT_NAME" "Backup verification: SUCCESS"
    else
        logger -t "$SCRIPT_NAME" "Backup verification: FAILURE ($exit_code issues)"
    fi
}

# Main execution
main() {
    log "Starting backup verification process"
    
    # Check if running as root
    if [[ $EUID -ne 0 ]]; then
        error "This script must be run as root"
    fi
    
    # Check dependencies
    if ! command -v rclone &> /dev/null; then
        error "rclone not found"
    fi
    
    if ! command -v jq &> /dev/null; then
        error "jq not found"
    fi
    
    # Load configuration
    load_config
    
    # Check rclone configuration
    if ! rclone config show {{ rclone_config_name }} &>/dev/null; then
        error "rclone remote '{{ rclone_config_name }}' not configured"
    fi
    
    # Perform verification
    local verify_errors=0
    verify_backup || verify_errors=$?
    
    # Check backup age
    check_backup_age
    
    # Generate report
    generate_report $verify_errors
    
    exit $verify_errors
}

# Handle script arguments
case "${1:-verify}" in
    "verify")
        main
        ;;
    "age")
        load_config
        check_backup_age
        ;;
    "help"|"-h"|"--help")
        echo "Usage: $0 {verify|age|help}"
        echo "  verify - Verify backup integrity (default)"
        echo "  age    - Check backup age"
        echo "  help   - Show this help"
        exit 0
        ;;
    *)
        error "Unknown command: $1. Use 'help' for usage."
        ;;
esac
