---
# cgit Addon - Main Tasks

- name: Install required packages
  ansible.builtin.pacman:
    name:
      - cgit
      - fcgiwrap
      - highlight
    state: present
  when: ansible_distribution == "Archlinux"

- name: Create git user
  ansible.builtin.user:
    name: "{{ cgit_fcgi_user }}"
    system: true
    shell: /usr/bin/git-shell
    home: "{{ cgit_repo_path }}"
    create_home: false

- name: Create cgit directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: root
    group: root
  loop:
    - "{{ cgit_repo_path }}"
    - "{{ cgit_cache_path }}"
    - "{{ cgit_log_path }}"
    - "/run/cgit"

- name: Create git repositories directory
  ansible.builtin.file:
    path: "{{ cgit_repo_path }}"
    state: directory
    mode: '0755'
    owner: "{{ cgit_fcgi_user }}"
    group: "{{ cgit_fcgi_group }}"

- name: Deploy cgit configuration
  ansible.builtin.template:
    src: cgitrc.j2
    dest: "{{ cgit_config_file }}"
    mode: '0644'
    owner: root
    group: root
  notify: restart fcgiwrap

- name: Deploy Caddy configuration for cgit
  ansible.builtin.template:
    src: cgit.caddy.j2
    dest: "{{ cgit_caddy_config }}"
    mode: '0644'
    owner: root
    group: root
  notify: reload caddy

- name: Deploy fcgiwrap systemd service
  ansible.builtin.template:
    src: fcgiwrap.service.j2
    dest: /etc/systemd/system/fcgiwrap.service
    mode: '0644'
    owner: root
    group: root

- name: Deploy fcgiwrap systemd socket
  ansible.builtin.template:
    src: fcgiwrap.socket.j2
    dest: /etc/systemd/system/fcgiwrap.socket
    mode: '0644'
    owner: root
    group: root

- name: Enable and start fcgiwrap socket
  ansible.builtin.systemd:
    name: fcgiwrap.socket
    state: started
    enabled: true
    daemon_reload: true

- name: Create cgit CSS file
  ansible.builtin.copy:
    content: |
      /* cgit default styling */
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        line-height: 1.6;
        color: #333;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      
      #header {
        background-color: #f6f8fa;
        padding: 20px;
        border-radius: 6px;
        margin-bottom: 20px;
      }
      
      #header h1 {
        margin: 0;
        color: #24292e;
      }
      
      #content {
        background-color: #fff;
        padding: 20px;
        border: 1px solid #e1e4e8;
        border-radius: 6px;
      }
      
      table.list {
        width: 100%;
        border-collapse: collapse;
      }
      
      table.list th,
      table.list td {
        padding: 8px 12px;
        text-align: left;
        border-bottom: 1px solid #e1e4e8;
      }
      
      table.list th {
        background-color: #f6f8fa;
        font-weight: 600;
      }
      
      a {
        color: #0366d6;
        text-decoration: none;
      }
      
      a:hover {
        text-decoration: underline;
      }
      
      .age {
        color: #586069;
        font-size: 0.9em;
      }
      
      .reposize {
        color: #586069;
        font-size: 0.9em;
      }
    dest: "{{ cgit_repo_path }}/cgit.css"
    mode: '0644'
    owner: root
    group: root

- name: Create repository scan script
  ansible.builtin.template:
    src: scan-repos.sh.j2
    dest: /usr/local/bin/scan-cgit-repos
    mode: '0755'
    owner: root
    group: root

- name: Create periodic repository scan
  ansible.builtin.cron:
    name: "Scan cgit repositories"
    job: "/usr/local/bin/scan-cgit-repos"
    minute: "0"
    hour: "*/6"
    user: root
    cron_file: cgit-scan

- name: Create sample repository
  ansible.builtin.shell: |
    cd {{ cgit_repo_path }}
    if [[ ! -d "sample-repo.git" ]]; then
        mkdir sample-repo.git
        cd sample-repo.git
        git init --bare
        echo "Sample repository for cgit" > description
        echo "main" > HEAD
    fi
  args:
    creates: "{{ cgit_repo_path }}/sample-repo.git"
  become_user: "{{ cgit_fcgi_user }}"

- name: Set proper permissions for git repositories
  ansible.builtin.file:
    path: "{{ cgit_repo_path }}"
    state: directory
    mode: '0755'
    owner: "{{ cgit_fcgi_user }}"
    group: "{{ cgit_fcgi_group }}"
    recurse: true

- name: Create cgit health check endpoint
  ansible.builtin.copy:
    content: |
      #!/bin/bash
      # cgit health check
      
      if systemctl is-active fcgiwrap.socket &>/dev/null; then
          echo "cgit: OK"
          exit 0
      else
          echo "cgit: FAILED"
          exit 1
      fi
    dest: /usr/local/bin/cgit-health
    mode: '0755'
    owner: root
    group: root

- name: Display cgit setup information
  ansible.builtin.debug:
    msg:
      - "cgit addon configured successfully"
      - "Repository path: {{ cgit_repo_path }}"
      - "Web URL: http://localhost{{ cgit_url_prefix }}/"
      - "Configuration: {{ cgit_config_file }}"
      - ""
      - "Next steps:"
      - "1. Add git repositories to {{ cgit_repo_path }}"
      - "2. Run 'scan-cgit-repos' to update repository list"
      - "3. Access cgit at the URL above"
      - ""
      - "Repository format:"
      - "  - Create bare repositories: git init --bare repo.git"
      - "  - Add description: echo 'Repo description' > repo.git/description"
      - "  - Set default branch: echo 'main' > repo.git/HEAD"
