{# cgit Caddy Configuration #}
{%- if cgit_domain | length > 0 -%}
{# Domain-based configuration #}
{{ cgit_domain }} {
    root * /usr/share/webapps/cgit
    encode gzip zstd
    
    # Security headers
    header {
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        X-XSS-Protection "1; mode=block"
        Referrer-Policy strict-origin-when-cross-origin
    }
    
    # Handle cgit via FastCGI
    handle /cgit.cgi {
        reverse_proxy unix//{{ cgit_fcgi_socket }} {
            transport fastcgi {
                env SCRIPT_FILENAME /usr/share/webapps/cgit/cgit.cgi
            }
        }
    }
    
    # Rewrite URLs to cgit.cgi
    handle_path /* {
        rewrite * /cgit.cgi{path}
    }
    
    # Serve static files directly
    handle /cgit.css {
        file_server
    }
    
    handle /favicon.ico {
        file_server
    }
    
    # Logging
    log {
        output file /var/log/caddy/cgit.log {
            roll_size 100mb
            roll_keep 5
            roll_keep_for 720h
        }
        format json
    }
    
    # Health check
    handle /health {
        respond "OK" 200
    }
}
{%- else -%}
{# Path-based configuration #}
{{ cgit_url_prefix }} {
    root * /usr/share/webapps/cgit
    encode gzip zstd
    
    # Security headers
    header {
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        X-XSS-Protection "1; mode=block"
        Referrer-Policy strict-origin-when-cross-origin
    }
    
    # Handle cgit via FastCGI
    handle /cgit.cgi {
        reverse_proxy unix//{{ cgit_fcgi_socket }} {
            transport fastcgi {
                env SCRIPT_FILENAME /usr/share/webapps/cgit/cgit.cgi
            }
        }
    }
    
    # Rewrite URLs to cgit.cgi
    handle_path /* {
        rewrite * /cgit.cgi{path}
    }
    
    # Serve static files directly
    handle /cgit.css {
        file_server
    }
    
    handle /favicon.ico {
        file_server
    }
    
    # Strip prefix for internal file serving
    route {
        strip_prefix {{ cgit_url_prefix }}
    }
    
    # Logging
    log {
        output file /var/log/caddy/cgit.log {
            roll_size 100mb
            roll_keep 5
            roll_keep_for 720h
        }
        format json
    }
    
    # Health check
    handle {{ cgit_url_prefix }}/health {
        respond "OK" 200
    }
}
{%- endif -%}
