# CrowdSec Agent Configuration
# Generated by Ansible

# General configuration
common:
  log_media: file
  log_level: {{ crowdsec_agent_log_level }}
  log_dir: {{ crowdsec_log_path }}
  log_file: {{ crowdsec_agent_log_file }}
  pid_dir: /run/crowdsec
  daemonize: true
  pprof_enabled: false
  pprof_port: 6060
  prometheus_enabled: {{ crowdsec_metrics_enabled | lower }}
  prometheus_port: {{ crowdsec_metrics_port }}
  prometheus_endpoint: {{ crowdsec_metrics_endpoint }}

# Agent configuration
agent:
  introspection_addr: 127.0.0.1:{{ crowdsec_agent_api_port }}
  api_server: true
  api_url: http://localhost:{{ crowdsec_agent_port }}/
  api_token: {{ crowdsec_enroll_key }}
  machine_id: {{ ansible_hostname }}
  dns_resolution: true
  max_memory: {{ crowdsec_max_memory }}
  max_cpu: {{ crowdsec_max_cpu }}
  worker_count: {{ crowdsec_worker_count }}

# Acquis configuration (what to monitor)
acquis:
  # System logs
  - type: file
    file_path: /var/log/auth.log
    labels:
      type: syslog
  - type: file
    file_path: /var/log/secure
    labels:
      type: syslog
  - type: file
    file_path: /var/log/messages
    labels:
      type: syslog
  
  # Caddy logs
  - type: file
    file_path: /var/log/caddy/access.log
    labels:
      type: caddy
  - type: file
    file_path: /var/log/caddy/error.log
    labels:
      type: caddy
  
  # Nginx logs (if present)
  - type: file
    file_path: /var/log/nginx/access.log
    labels:
      type: nginx
  - type: file
    file_path: /var/log/nginx/error.log
    labels:
      type: nginx
  
  # Apache logs (if present)
  - type: file
    file_path: /var/log/apache2/access.log
    labels:
      type: apache
  - type: file
    file_path: /var/log/apache2/error.log
    labels:
      type: apache
  
  # Docker logs (if present)
  - type: docker
    container_name: caddy
    labels:
      type: docker
  - type: docker
    container_name: immich-server
    labels:
      type: docker
  - type: docker
    container_name: immich-database
    labels:
      type: docker

# Parser configuration
parser:
  # Enable default parsers
  default_parsers: true
  
  # Custom parsers
  custom_parsers:
    - name: caddy-access
      filename: parsers/caddy-access.yaml
    - name: caddy-error
      filename: parsers/caddy-error.yaml

# Scenario configuration
scenarios:
  - name: crowdsecurity/http-scan
  - name: crowdsecurity/http-bad-user-agent
  - name: crowdsecurity/http-path-traversal
  - name: crowdsecurity/http-sqli-detect
  - name: crowdsecurity/http-xss-detect
  - name: crowdsecurity/ssh-bf
  - name: crowdsecurity/ssh-bruteforce
  - name: crowdsecurity/ssh-slow-bruteforce
  - name: crowdsecurity/ssh-new-cf
  - name: crowdsecurity/ssh-suspicious-user
  - name: crowdsecurity/ssh-wrong-user
  - name: crowdsecurity/linux-suspicious-activity
  - name: crowdsecurity/linux-logs-detection
  - name: crowdsecurity/docker-logs-detection
  
  # Custom scenarios
  - name: custom/web-attacks
    filename: scenarios/custom.yaml

# Postoverflow configuration
postoverflow:
  # Enable default postoverflow
  default_postoverflow: true
  
  # Custom postoverflow
  custom_postoverflow:
    - name: crowdsec-whitelist
      filename: postoverflows/whitelist.yaml

# Decision configuration
decision:
  # Decision stream configuration
  stream:
    enabled: {{ crowdsec_stream_mode | lower }}
    api_url: https://api.crowdsec.net/
    api_token: {{ crowdsec_enroll_key }}
    scrape_interval: 1s
    scrape_timeout: 1s
    clean_interval: 1h
    clean_duration: 48h
  
  # Local decisions
  local:
    enabled: true
    clean_interval: 1h
    clean_duration: 24h

# Database configuration
database:
  type: sqlite
  db_path: {{ crowdsec_data_path }}/crowdsec.db
  max_open_conns: 100
  max_idle_conns: 50
  conn_max_lifetime: 1h

# API configuration
api:
  server:
    listen_uri: 127.0.0.1:{{ crowdsec_agent_port }}
    trusted_proxies:
      - 127.0.0.1
      - ::1
    tls:
      enabled: false
      cert_file: ""
      key_file: ""
  
  client:
    credentials:
      - api_key: {{ crowdsec_enroll_key }}
    insecure_skip_verify: false

# Plugin configuration
plugins:
  # Enable default plugins
  default_plugins: true
  
  # Custom plugins
  custom_plugins: []

# Machine learning configuration
machine_learning:
  enabled: {{ crowdsec_ml_enabled | lower }}
  model_path: {{ crowdsec_ml_model_path }}
  training_interval: 24h
  prediction_threshold: 0.7

# Notification configuration
notifications:
  enabled: {{ crowdsec_notifications_enabled | lower }}
  
  # Webhook notifications
  webhook:
    enabled: {{ (crowdsec_notification_webhook != "") | lower }}
    url: {{ crowdsec_notification_webhook }}
    method: POST
    headers:
      Content-Type: application/json
    timeout: 10s
  
  # Email notifications
  email:
    enabled: {{ (crowdsec_notification_email != "") | lower }}
    smtp:
      host: ""
      port: 587
      username: ""
      password: ""
      from: ""
      to: {{ crowdsec_notification_email }}
    timeout: 10s

# Metrics configuration
metrics:
  enabled: {{ crowdsec_metrics_enabled | lower }}
  port: {{ crowdsec_metrics_port }}
  endpoint: {{ crowdsec_metrics_endpoint }}
  
  # Custom metrics
  custom_metrics: []

# Debug configuration
debug:
  enabled: {{ crowdsec_debug_mode | lower }}
  profiling: {{ crowdsec_agent_profiling | lower }}
  trace: false
