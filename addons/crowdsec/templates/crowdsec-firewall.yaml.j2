# CrowdSec Firewall Bouncer Configuration
# Generated by Ansible

# General configuration
mode: {{ crowdsec_bouncer_mode }}
puid: 0
pgid: 0
log_level: info
log_file: {{ crowdsec_log_path }}/firewall.log
log_syslog: false
pid_dir: /run/crowdsec
daemonize: true

# API configuration
api_url: http://127.0.0.1:{{ crowdsec_agent_api_port }}/
api_key: {{ crowdsec_enroll_key }}

# Decision configuration
decision_timeout: {{ crowdsec_bouncer_decision_timeout }}
clean_ip_cache_duration: {{ crowdsec_bouncer_clean_ip_cache_duration }}
clean_scenario_cache_duration: {{ crowdsec_bouncer_clean_scenario_cache_duration }}

# Firewall configuration
firewall: {{ crowdsec_firewall_type }}
deny_log: true
deny_action: drop
supported_decisions_types:
  - ban
  - captcha
  - throttle

# nftables specific configuration
nftables:
  table: crowdsec
  chain: crowdsec
  priority: -100
  ipv4_enabled: true
  ipv6_enabled: true

# iptables specific configuration (fallback)
iptables:
  ipv4:
    table: filter
    chain: INPUT
    priority: -100
  ipv6:
    table: filter
    chain: INPUT
    priority: -100

# Blocklist configuration
blocklist_enabled: {{ crowdsec_blocklist_enabled | lower }}
blocklist_sources: {{ crowdsec_blocklist_sources | to_json }}
blocklist_refresh_interval: 1h
blocklist_download_timeout: 30s

# Performance configuration
max_decisions: 10000
batch_size: 100
process_timeout: 10s

# Security configuration
disable_ipv6: false
only_log: false
fail2ban_api_key: ""
fail2ban_api_url: ""

# Metrics configuration
metrics_enabled: {{ crowdsec_metrics_enabled | lower }}
metrics_port: 6061
metrics_endpoint: /metrics

# Debug configuration
debug: {{ crowdsec_debug_mode | lower }}
dry_run: false

# Custom rules
custom_rules:
  # Allow established connections
  - action: allow
    protocol: all
    state: established
  - action: allow
    protocol: all
    state: related
  
  # Allow loopback
  - action: allow
    protocol: all
    source: 127.0.0.1/8
  - action: allow
    protocol: all
    source: ::1/128
  
  # Allow SSH (with rate limiting)
  - action: allow
    protocol: tcp
    destination_port: 22
    source: any
    state: new
  
  # Allow HTTP/HTTPS (with rate limiting)
  - action: allow
    protocol: tcp
    destination_port: 80
    source: any
    state: new
  - action: allow
    protocol: tcp
    destination_port: 443
    source: any
    state: new
  
  # Allow Cloudflare IPs (if configured)
  {%- if crowdsec_cloudflare_ips is defined %}
  - action: allow
    protocol: tcp
    destination_port: 80
    source: {{ crowdsec_cloudflare_ips | join(',') }}
    state: new
  - action: allow
    protocol: tcp
    destination_port: 443
    source: {{ crowdsec_cloudflare_ips | join(',') }}
    state: new
  {%- endif %}

# Integration configuration
integrations:
  caddy:
    enabled: {{ crowdsec_caddy_integration | lower }}
    log_path: /var/log/caddy/access.log
    ban_duration: {{ crowdsec_caddy_block_duration }}
    ban_threshold: {{ crowdsec_caddy_ban_threshold }}
  
  nginx:
    enabled: {{ crowdsec_nginx_integration | lower }}
    log_path: /var/log/nginx/access.log
    ban_duration: 4h
    ban_threshold: 5
  
  apache:
    enabled: {{ crowdsec_apache_integration | lower }}
    log_path: /var/log/apache2/access.log
    ban_duration: 4h
    ban_threshold: 5

# Notification configuration
notifications:
  enabled: {{ crowdsec_notifications_enabled | lower }}
  
  # Webhook notifications
  webhook:
    enabled: {{ (crowdsec_notification_webhook != "") | lower }}
    url: {{ crowdsec_notification_webhook }}
    method: POST
    headers:
      Content-Type: application/json
    timeout: 10s
  
  # Email notifications
  email:
    enabled: {{ (crowdsec_notification_email != "") | lower }}
    smtp:
      host: ""
      port: 587
      username: ""
      password: ""
      from: ""
      to: {{ crowdsec_notification_email }}
    timeout: 10s

# Whitelist configuration
whitelist:
  # Local networks
  - 127.0.0.0/8
  - ::1/128
  - 10.0.0.0/8
  - 172.16.0.0/12
  - 192.168.0.0/16
  
  # Custom whitelisted IPs
  {%- if crowdsec_whitelist_ips is defined %}
  {% for ip in crowdsec_whitelist_ips %}
  - {{ ip }}
  {% endfor %}
  {%- endif %}

# Blacklist configuration
blacklist:
  # Known malicious IPs (will be automatically updated)
  auto_update: true
  update_interval: 1h
  
  # Custom blacklisted IPs
  {%- if crowdsec_blacklist_ips is defined %}
  {% for ip in crowdsec_blacklist_ips %}
  - {{ ip }}
  {% endfor %}
  {%- endif %}
