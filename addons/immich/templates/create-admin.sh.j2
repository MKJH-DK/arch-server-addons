#!/bin/bash
# Immich Admin User Creation Script

set -euo pipefail

# Configuration
SCRIPT_NAME="$(basename "$0")"
IMMICH_URL="http://localhost:{{ immich_server_port }}"
ADMIN_EMAIL="{{ immich_admin_email }}"
ADMIN_PASSWORD="{{ immich_admin_password }}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Logging
log() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Check if Immich is running
check_immich_running() {
    if ! curl -s "$IMMICH_URL/api/server-info/ping" > /dev/null; then
        log_error "Immich server is not running at $IMMICH_URL"
        log_info "Start Immich with: cd {{ immich_data_path }} && docker compose up -d"
        exit 1
    fi
}

# Check if admin user already exists
check_admin_exists() {
    local response
    response=$(curl -s "$IMMICH_URL/api/auth/admin-signup" || echo "")
    
    if [[ "$response" == *"true"* ]]; then
        log_info "Admin user registration is available"
        return 1  # Admin doesn't exist
    else
        log_info "Admin user already exists"
        return 0  # Admin exists
    fi
}

# Create admin user
create_admin_user() {
    log "Creating admin user..."
    
    local payload
    payload=$(cat << EOF
{
    "email": "$ADMIN_EMAIL",
    "password": "$ADMIN_PASSWORD",
    "firstName": "Admin",
    "lastName": "User"
}
EOF
)
    
    local response
    response=$(curl -s -X POST \
        -H "Content-Type: application/json" \
        -d "$payload" \
        "$IMMICH_URL/api/auth/admin-signup")
    
    if [[ "$response" == *"accessToken"* ]]; then
        log_success "Admin user created successfully"
        log "Email: $ADMIN_EMAIL"
        log "Password: [configured]"
        
        # Extract access token for verification
        local token
        token=$(echo "$response" | grep -o '"accessToken":"[^"]*"' | cut -d'"' -f4)
        
        if [[ -n "$token" ]]; then
            log "Access token obtained successfully"
            
            # Verify admin user
            verify_admin_user "$token"
        fi
    else
        log_error "Failed to create admin user"
        log "Response: $response"
        exit 1
    fi
}

# Verify admin user
verify_admin_user() {
    local token="$1"
    
    log "Verifying admin user..."
    
    local response
    response=$(curl -s -H "Authorization: Bearer $token" \
        "$IMMICH_URL/api/users/me")
    
    if [[ "$response" == *"$ADMIN_EMAIL"* ]]; then
        log_success "Admin user verified successfully"
    else
        log_warning "Admin user verification failed"
    fi
}

# Show usage
show_usage() {
    echo "Usage: $0 [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  -h, --help     Show this help"
    echo "  -c, --check    Check if admin user exists"
    echo "  -f, --force    Force create admin user (if possible)"
    echo ""
    echo "Environment:"
    echo "  IMMICH_URL: $IMMICH_URL"
    echo "  ADMIN_EMAIL: $ADMIN_EMAIL"
}

# Main execution
main() {
    local check_only=false
    local force=false
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                show_usage
                exit 0
                ;;
            -c|--check)
                check_only=true
                shift
                ;;
            -f|--force)
                force=true
                shift
                ;;
            *)
                log_error "Unknown option: $1"
                show_usage
                exit 1
                ;;
        esac
    done
    
    log "Immich Admin User Management"
    log "Server: $IMMICH_URL"
    log "Email: $ADMIN_EMAIL"
    echo ""
    
    # Check if Immich is running
    check_immich_running
    
    # Check if admin exists
    if check_admin_exists; then
        if [[ "$check_only" == "true" ]]; then
            log "Admin user exists"
            exit 0
        fi
        
        if [[ "$force" != "true" ]]; then
            log_warning "Admin user already exists"
            log "Use --force to attempt creation (may fail if registration is disabled)"
            exit 1
        fi
    fi
    
    if [[ "$check_only" == "true" ]]; then
        log "Admin user does not exist"
        exit 0
    fi
    
    # Create admin user
    create_admin_user
    
    log ""
    log_success "Admin user setup completed"
    log "You can now login to Immich at:"
    log "  Local: http://localhost{{ immich_url_prefix }}/"
    {%- if immich_domain | length > 0 %}
    log "  Domain: https://{{ immich_domain }}/"
    {%- endif %}
    log ""
    log "Credentials:"
    log "  Email: $ADMIN_EMAIL"
    log "  Password: [configured in deployment]"
}

# Run main function
main "$@"
