#!/bin/bash
# Immich Health Check Script

set -euo pipefail

# Configuration
SCRIPT_NAME="$(basename "$0")"
IMMICH_DATA_PATH="{{ immich_data_path }}"
IMMICH_SERVER_URL="http://localhost:{{ immich_server_port }}"
HEALTH_CHECK_TIMEOUT=30

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Logging
log() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[OK]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[FAIL]${NC} $1"
}

# Check Docker services
check_docker_services() {
    local services_running=0
    local total_services=0
    
    log "Checking Docker services..."
    
    while IFS= read -r service; do
        ((total_services++))
        local status
        status=$(docker compose -f "$IMMICH_DATA_PATH/docker-compose.yml" ps -q "$service" | xargs docker inspect --format='{{.State.Status}}' 2>/dev/null || echo "not_found")
        
        if [[ "$status" == "running" ]]; then
            log_success "$service: running"
            ((services_running++))
        else
            log_error "$service: $status"
        fi
    done < <(docker compose -f "$IMMICH_DATA_PATH/docker-compose.yml" config --services)
    
    log "Docker services: $services_running/$total_services running"
    return $((total_services - services_running))
}

# Check Immich API
check_immich_api() {
    log "Checking Immich API..."
    
    if curl -s --max-time "$HEALTH_CHECK_TIMEOUT" "$IMMICH_SERVER_URL/api/server-info/ping" | grep -q "pong"; then
        log_success "Immich API: responsive"
        return 0
    else
        log_error "Immich API: not responding"
        return 1
    fi
}

# Check database connection
check_database() {
    log "Checking database connection..."
    
    if docker compose -f "$IMMICH_DATA_PATH/docker-compose.yml" exec -T immich-database pg_isready -U {{ immich_db_user }} -d {{ immich_db_name }} &>/dev/null; then
        log_success "Database: connected"
        
        # Check if tables exist
        local table_count
        table_count=$(docker compose -f "$IMMICH_DATA_PATH/docker-compose.yml" exec -T immich-database psql -U {{ immich_db_user }} -d {{ immich_db_name }} -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';" 2>/dev/null | tr -d ' ' || echo "0")
        
        if [[ $table_count -gt 0 ]]; then
            log_success "Database: $table_count tables found"
            return 0
        else
            log_warning "Database: no tables found (may need initialization)"
            return 1
        fi
    else
        log_error "Database: not connected"
        return 1
    fi
}

# Check Redis connection
check_redis() {
    log "Checking Redis connection..."
    
    if docker compose -f "$IMMICH_DATA_PATH/docker-compose.yml" exec -T immich-redis redis-cli ping | grep -q "PONG"; then
        log_success "Redis: connected"
        return 0
    else
        log_error "Redis: not connected"
        return 1
    fi
}

# Check storage paths
check_storage() {
    log "Checking storage paths..."
    
    local paths=(
        "{{ immich_upload_path }}"
        "{{ immich_library_path }}"
        "{{ immich_thumb_path }}"
        "{{ immich_profile_path }}"
    )
    
    local issues=0
    
    for path in "${paths[@]}"; do
        if [[ -d "$path" ]]; then
            local size
            size=$(du -sh "$path" 2>/dev/null | cut -f1 || echo "unknown")
            local files
            files=$(find "$path" -type f 2>/dev/null | wc -l)
            log_success "$(basename "$path"): $size ($files files)"
        else
            log_error "$(basename "$path"): not found"
            ((issues++))
        fi
    done
    
    return $issues
}

# Check disk space
check_disk_space() {
    log "Checking disk space..."
    
    local paths=(
        "{{ immich_data_path }}"
        "{{ immich_upload_path }}"
    )
    
    local issues=0
    
    for path in "${paths[@]}"; do
        if [[ -d "$path" ]]; then
            local usage
            usage=$(df "$path" | awk 'NR==2 {print $5}' | sed 's/%//' || echo "0")
            
            if [[ $usage -lt 80 ]]; then
                log_success "$(basename "$path"): ${usage}% used"
            elif [[ $usage -lt 90 ]]; then
                log_warning "$(basename "$path"): ${usage}% used"
            else
                log_error "$(basename "$path"): ${usage}% used"
                ((issues++))
            fi
        fi
    done
    
    return $issues
}

# Check memory usage
check_memory() {
    log "Checking memory usage..."
    
    # Check system memory
    local mem_usage
    mem_usage=$(free | awk 'NR==2{printf "%.0f", $3*100/$2}')
    
    if [[ $mem_usage -lt 80 ]]; then
        log_success "System memory: ${mem_usage}% used"
    elif [[ $mem_usage -lt 90 ]]; then
        log_warning "System memory: ${mem_usage}% used"
    else
        log_error "System memory: ${mem_usage}% used"
    fi
    
    # Check Docker container memory
    local containers
    containers=(immich-server immich-machine-learning immich-database immich-redis)
    
    for container in "${containers[@]}"; do
        if docker ps --format "table {{.Names}}" | grep -q "$container"; then
            local mem_usage_container
            mem_usage_container=$(docker stats --no-stream --format "table {{.MemPerc}}" "$container" | tail -1 | sed 's/%//' || echo "0")
            
            if [[ -n "$mem_usage_container" && "$mem_usage_container" != "0" ]]; then
                log_success "$container: ${mem_usage_container}% memory"
            fi
        fi
    done
}

# Show system summary
show_summary() {
    local total_issues=$1
    
    echo ""
    echo "=== Immich Health Summary ==="
    
    if [[ $total_issues -eq 0 ]]; then
        log_success "All checks passed"
        echo "Status: HEALTHY"
    else
        log_warning "$total_issues issues found"
        echo "Status: WARNING"
    fi
    
    echo ""
    echo "Service URLs:"
    echo "  Immich Web: http://localhost{{ immich_url_prefix }}/"
    {%- if immich_domain | length > 0 %}
    echo "  Immich Web: https://{{ immich_domain }}/"
    {%- endif %}
    echo "  API: $IMMICH_SERVER_URL"
    echo ""
    echo "Data paths:"
    echo "  Uploads: {{ immich_upload_path }}"
    echo "  Library: {{ immich_library_path }}"
    echo "  Thumbs: {{ immich_thumb_path }}"
    echo "  Profile: {{ immich_profile_path }}"
    echo ""
    echo "Docker management:"
    echo "  Logs: cd $IMMICH_DATA_PATH && docker compose logs -f"
    echo "  Restart: cd $IMMICH_DATA_PATH && docker compose restart"
    echo "  Stop: cd $IMMICH_DATA_PATH && docker compose down"
    echo "  Start: cd $IMMICH_DATA_PATH && docker compose up -d"
    echo "=========================="
}

# Show usage
show_usage() {
    echo "Usage: $0 [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  -h, --help     Show this help"
    echo "  -q, --quiet    Only show summary"
    echo "  -s, --service  Check specific service only"
    echo ""
    echo "Services: docker, api, database, redis, storage, disk, memory"
}

# Main execution
main() {
    local quiet=false
    local service_only=""
    local total_issues=0
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                show_usage
                exit 0
                ;;
            -q|--quiet)
                quiet=true
                shift
                ;;
            -s|--service)
                service_only="$2"
                shift 2
                ;;
            *)
                log_error "Unknown option: $1"
                show_usage
                exit 1
                ;;
        esac
    done
    
    # Check if running as root
    if [[ $EUID -ne 0 ]]; then
        log_error "This script must be run as root"
        exit 1
    fi
    
    # Run health checks
    if [[ -n "$service_only" ]]; then
        case "$service_only" in
            docker)
                check_docker_services
                ;;
            api)
                check_immich_api
                ;;
            database)
                check_database
                ;;
            redis)
                check_redis
                ;;
            storage)
                check_storage
                ;;
            disk)
                check_disk_space
                ;;
            memory)
                check_memory
                ;;
            *)
                log_error "Unknown service: $service_only"
                show_usage
                exit 1
                ;;
        esac
        exit $?
    fi
    
    if [[ "$quiet" != "true" ]]; then
        echo "Immich Health Check"
        echo "==================="
        echo ""
    fi
    
    # Run all checks
    if [[ "$quiet" != "true" ]]; then
        check_docker_services || ((total_issues++))
        check_immich_api || ((total_issues++))
        check_database || ((total_issues++))
        check_redis || ((total_issues++))
        check_storage || ((total_issues++))
        check_disk_space || ((total_issues++))
        check_memory
    else
        # Quiet mode - just check critical services
        check_docker_services >/dev/null 2>&1 || ((total_issues++))
        check_immich_api >/dev/null 2>&1 || ((total_issues++))
        check_database >/dev/null 2>&1 || ((total_issues++))
    fi
    
    # Show summary
    show_summary $total_issues
    
    # Exit with appropriate code
    if [[ $total_issues -eq 0 ]]; then
        exit 0
    else
        exit 1
    fi
}

# Run main function
main "$@"
