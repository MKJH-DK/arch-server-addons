#!/bin/bash
# Build all Quartz sites from the Obsidian vault _public/ sections.
# Generated by Ansible (obsidian-web addon). Do not edit manually.
#
# For each configured site this script:
#   1. Copies the site-specific quartz.config.ts into the Quartz installation.
#   2. Clears the Quartz build cache (ensures a clean output for the new config).
#   3. Runs: npx quartz build --directory <vault>/_public/<site> --output <webroot>/<site>
#
# It is called by the quartz-build.service systemd unit and can also be
# invoked manually: /usr/local/bin/build-quartz-sites [site-name]
#
# Skips any site whose _public/<name>/ directory does not yet exist in the vault.

set -euo pipefail

readonly QUARTZ_DIR="{{ obsidian_quartz_path }}"
readonly QUARTZ_CONFIGS_DIR="{{ obsidian_quartz_configs_path }}"
readonly VAULT_PUBLIC_DIR="{{ obsidian_vault_path }}/_public"
readonly WEB_ROOT="{{ obsidian_web_root }}"
readonly LOG_FILE="/var/log/quartz-build.log"

# ── Logging ───────────────────────────────────────────────────────────────────

log() {
    local level="$1"
    shift
    printf '[%s] [%s] %s\n' "$(date '+%Y-%m-%d %H:%M:%S')" "$level" "$*" \
        | tee -a "${LOG_FILE}"
}

log_info()  { log "INFO " "$@"; }
log_warn()  { log "WARN " "$@"; }
log_error() { log "ERROR" "$@"; }

# ── Build a single site ───────────────────────────────────────────────────────

build_site() {
    local site_name="$1"
    local content_dir="${VAULT_PUBLIC_DIR}/${site_name}"
    local output_dir="${WEB_ROOT}/${site_name}"
    local config_src="${QUARTZ_CONFIGS_DIR}/${site_name}.ts"

    if [[ ! -d "${content_dir}" ]]; then
        log_warn "Skipping '${site_name}': _public/${site_name}/ not found in vault"
        return 0
    fi

    if [[ ! -f "${config_src}" ]]; then
        log_error "Skipping '${site_name}': config ${config_src} not found (re-run ansible)"
        return 1
    fi

    log_info "Building site: ${site_name}"

    # Install site-specific config
    cp "${config_src}" "${QUARTZ_DIR}/quartz.config.ts"

    # Clear build cache so the previous site's index does not bleed into this one
    rm -rf "${QUARTZ_DIR}/.quartz-cache"

    # Ensure the output directory exists
    mkdir -p "${output_dir}"

    # Build
    cd "${QUARTZ_DIR}"
    npx quartz build \
        --directory "${content_dir}" \
        --output    "${output_dir}" \
        2>> "${LOG_FILE}"

    log_info "Done: ${site_name}  →  ${output_dir}"
}

# ── Main ──────────────────────────────────────────────────────────────────────

main() {
    log_info "=== Quartz build started ==="

    if [[ $# -gt 0 ]]; then
        # Build a single named site when passed as argument
        build_site "$1"
    else
        # Build all configured sites
{% for site in obsidian_sites %}
        build_site "{{ site.name }}"
{% endfor %}
    fi

    log_info "=== Quartz build complete ==="
}

main "$@"
