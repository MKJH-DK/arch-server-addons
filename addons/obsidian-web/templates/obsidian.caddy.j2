# Obsidian Web Sites - generated by Ansible (obsidian-web addon)
# Do not edit manually; changes will be overwritten on next deploy.
#
# Sites with a domain configured get a dedicated HTTPS virtual host.
# Sites without a domain are served on localhost:8080 for local/dev access.

{% set domain_sites = obsidian_sites | selectattr('domain', 'ne', '') | list %}
{% set local_sites  = obsidian_sites | selectattr('domain', 'equalto', '') | list %}

{% for site in domain_sites %}
{{ site.domain }} {
    root * {{ obsidian_web_root }}/{{ site.name }}

    encode gzip zstd

    # Security headers
    header {
        X-Content-Type-Options   "nosniff"
        X-Frame-Options          "DENY"
        X-XSS-Protection         "1; mode=block"
        Referrer-Policy          "strict-origin-when-cross-origin"
        # Quartz loads fonts and scripts from its own bundle â€” no CDN needed
        Content-Security-Policy  "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'"
    }

    # Quartz generates HTML files as `page.html` on disk but internal links
    # use extensionless paths (`/page`). try_files rewrites the URI so Caddy
    # finds the correct file before falling through to file_server.
    try_files {path} {path}.html {path}/index.html

    file_server

    # Health check endpoint (used by deploy script to verify the site is up)
    handle /health {
        respond "OK" 200
    }

    log {
        output file /var/log/caddy/{{ site.name }}.log {
            roll_size    100mb
            roll_keep    5
            roll_keep_for 720h
        }
        format json
    }
}
{% endfor %}

{% if local_sites %}
# Development / local-only access for sites without a domain
# Accessible at http://localhost:8080/<site-name>/
# Configure a domain in obsidian_sites to get HTTPS for a site.
:8080 {
{% for site in local_sites %}
    handle /{{ site.name }}/* {
        root * {{ obsidian_web_root }}/{{ site.name }}
        try_files {path} {path}.html {path}/index.html
        file_server
    }

{% endfor %}
    # Redirect bare :8080 to the first local site for convenience
{% if local_sites %}
    redir / /{{ local_sites[0].name }}/ 302
{% endif %}
}
{% endif %}
